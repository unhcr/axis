with PPG
as
(
select
  ppg.ORIGPOPGROUP_ID,
  ppg.populationgroup_id ppg_id,
  op.name operation,
  op.OPERATIONID,
  p.PLANNINGYEAR,
  ppg.MSRPCODE PPG_MSRPCODE,
  ppg.POPULATIONGROUPNAME,
  sum(value) poc
from BI_OPERATION op
join BI_PLAN p on p.OPERATIONID = op.OPERATIONID and p.PLANNINGSTAGE = 8
join BI_PRJPOPULATIONGROUP ppg on ppg.PLANID = p.PLANID
join PSR_PPG_POPDETAILS pop on  (p.planningyear = pop.YEAR and ppg.MSRPCODE = pop.ppg_code)
group by
  ppg.ORIGPOPGROUP_ID,
  ppg.populationgroup_id,
  op.name,
  op.OPERATIONID,
  p.PLANNINGYEAR,
  ppg.MSRPCODE,
  ppg.POPULATIONGROUPNAME
)
-- By Operation
select
        PPG.OPERATIONID AS ELEMENT_ID,
        'operations' AS ELEMENT_TYPE,
        ppg.PPG_MSRPCODE PPG_CODE,
        ppg.ORIGPOPGROUP_ID,
        PLANNINGYEAR YEAR,
        sum(poc) AS POC
from PPG
group by
        PPG.OPERATIONID,
        ppg.ORIGPOPGROUP_ID,
        PPG.PPG_MSRPCODE,
        PLANNINGYEAR

UNION ALL

-- By PPG
select
        PPG.ORIGPOPGROUP_ID AS ELEMENT_ID,
        'ppgs' AS ELEMENT_TYPE,
        ppg.PPG_MSRPCODE PPG_CODE,
        ppg.ORIGPOPGROUP_ID,
        PLANNINGYEAR YEAR,
        sum(poc) AS POC
from PPG
group by
        PPG.ORIGPOPGROUP_ID,
        PLANNINGYEAR,
        PPG.PPG_MSRPCODE

UNION ALL

-- By Goal
select
        BI_GOAL.RFGOALID AS ELEMENT_ID,
        'goals' AS ELEMENT_TYPE,
        ppg.PPG_MSRPCODE PPG_CODE,
        ppg.ORIGPOPGROUP_ID,
        PLANNINGYEAR YEAR,
        sum(poc) AS POC
from PPG
join FOCUS_BI.BI_GOAL on PPG.ppg_id = BI_GOAL.POPULATIONGROUPID
group by
        BI_GOAL.RFGOALID,
        ppg.ORIGPOPGROUP_ID,
        PPG.PPG_MSRPCODE,
        PLANNINGYEAR

UNION ALL

-- By Objective
select
        BI_RFPROBLOBJ.ID AS ELEMENT_ID,
        'problem_objectives' AS ELEMENT_TYPE,
        ppg.PPG_MSRPCODE PPG_CODE,
        ppg.ORIGPOPGROUP_ID,
        PLANNINGYEAR YEAR,
        sum(poc) AS POC
from PPG
join FOCUS_BI.BI_GOAL on PPG.ppg_id = BI_GOAL.POPULATIONGROUPID
INNER JOIN BI_RFGOALS             ON BI_GOAL.RFGOALID = BI_RFGOALS.ID
INNER JOIN BI_RIGHTSGROUP         ON  BI_GOAL.GOALID=BI_RIGHTSGROUP.GOALID
INNER JOIN BI_RFRIGHTSGROUP       ON BI_RIGHTSGROUP.RFRIGHTSGROUPID = BI_RFRIGHTSGROUP.ID
INNER JOIN BI_OBJECTIVE           ON  BI_RIGHTSGROUP.RIGHTSGROUPID=BI_OBJECTIVE.RIGHTSGROUPID
INNER JOIN BI_RFPROBLOBJ          ON BI_OBJECTIVE.RFPROBLEMOBJECTIVEID = BI_RFPROBLOBJ.ID
group by
        BI_RFPROBLOBJ.ID,
        ppg.ORIGPOPGROUP_ID,
        PPG.PPG_MSRPCODE,
        PLANNINGYEAR

UNION ALL

-- By Output

select
        BI_RFOUTPUTS.ID AS ELEMENT_ID,
        'outputs' AS ELEMENT_TYPE,
        ppg.PPG_MSRPCODE PPG_CODE,
        ppg.ORIGPOPGROUP_ID,
        PLANNINGYEAR YEAR,
        sum(poc) AS POC
from PPG
join FOCUS_BI.BI_GOAL on PPG.ppg_id = BI_GOAL.POPULATIONGROUPID
INNER JOIN BI_RFGOALS             ON BI_GOAL.RFGOALID = BI_RFGOALS.ID
INNER JOIN BI_RIGHTSGROUP         ON  BI_GOAL.GOALID=BI_RIGHTSGROUP.GOALID
INNER JOIN BI_RFRIGHTSGROUP       ON BI_RIGHTSGROUP.RFRIGHTSGROUPID = BI_RFRIGHTSGROUP.ID
INNER JOIN BI_OBJECTIVE           ON  BI_RIGHTSGROUP.RIGHTSGROUPID=BI_OBJECTIVE.RIGHTSGROUPID
INNER JOIN BI_RFPROBLOBJ          ON BI_OBJECTIVE.RFPROBLEMOBJECTIVEID = BI_RFPROBLOBJ.ID
INNER JOIN BI_OUTPUTGRP          ON BI_OBJECTIVE.OBJECTIVEID=BI_OUTPUTGRP.OBJECTIVEID
INNER JOIN BI_RFOUTPUTS          ON BI_RFOUTPUTS.ID = BI_OUTPUTGRP.RFOUTPUTID
group by
        BI_RFOUTPUTS.ID,
        ppg.ORIGPOPGROUP_ID,
        PPG.PPG_MSRPCODE,
        PLANNINGYEAR
